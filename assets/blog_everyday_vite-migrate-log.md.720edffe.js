import{_ as s,o as a,c as n,a as p}from"./app.ed2a374b.js";const C=JSON.parse('{"title":"React 项目 Vite 迁移记录","description":"","frontmatter":{},"headers":[],"relativePath":"blog/everyday/vite-migrate-log.md","lastUpdated":1679813736000}'),l={name:"blog/everyday/vite-migrate-log.md"},o=p(`<h1 id="react-项目-vite-迁移记录" tabindex="-1">React 项目 Vite 迁移记录 <a class="header-anchor" href="#react-项目-vite-迁移记录" aria-hidden="true">#</a></h1><p><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202201221849441.jpg" alt="youxiaoyou"></p><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-hidden="true">#</a></h2><p>Vite 2.0 正式版在 21 年春节就发布了，之前一直有在关注尤大的社交账号，尤大在论坛上疯狂安利，当时就留下了很深的印象，正好今年 6 月，我有一场公司的分享会，于是想把手上的一个 React 小项目迁移，记录踩坑，然后作为分享内容。<strong>这里只是记录了我在项目中迁移遇到的坑，其他问题基本上可以在 <a href="https://github.com/Vitejs/Vite/issues" target="_blank" rel="noreferrer">Vite/issue</a> 中找到</strong>。最后关于 Vite 和<a href="https://Vitejs.cn/guide/why.html#why-Vite" target="_blank" rel="noreferrer">为什么选 Vite</a>，本文就不再阐述，官网已经给出了答案，Let&#39;s go！</p><p>先来看看迁移后的效果（同一项目的启动时间）</p><p>通过 webpack 启动，<strong>大概在 45s 左右</strong>。</p><p><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202112261817225.gif" alt="dev by webpack"></p><p>通过 Vite 启动，<strong>时间大概在 1.2s！！！</strong> 😱</p><p><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202112261817609.gif" alt="dev by Vite"></p><h2 id="开始迁移" tabindex="-1">开始迁移 <a class="header-anchor" href="#开始迁移" aria-hidden="true">#</a></h2><h3 id="移除-webpack-相关文件-依赖" tabindex="-1">移除 webpack 相关文件/依赖 <a class="header-anchor" href="#移除-webpack-相关文件-依赖" aria-hidden="true">#</a></h3><p>1.项目经过 eject 后会暴露配置，移除 <code>config</code> <code>scripts</code> 目录。</p><p><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202112261749441.png" alt="image-20210626181607914"><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202112261749403.png" alt="image-20210626183201556"></p><p>2.移除所有 webpack 相关依赖（webpack, xxx-loader, xxx-webpack-plugin，babel-xxx，postcss-xxx）</p><h3 id="引入-vite" tabindex="-1">引入 Vite <a class="header-anchor" href="#引入-vite" aria-hidden="true">#</a></h3><p>install devDependencies</p><div class="language-powershell"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#ADBAC7;">yarn add Vite @Vitejs</span><span style="color:#F47067;">/</span><span style="color:#ADBAC7;">plugin</span><span style="color:#F47067;">-</span><span style="color:#ADBAC7;">react</span><span style="color:#F47067;">-</span><span style="color:#ADBAC7;">refresh </span><span style="color:#F47067;">-</span><span style="color:#ADBAC7;">D</span></span>
<span class="line"></span></code></pre></div><p>创建 <code>Vite.config.js</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#768390;">// Vite.config.js</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> { defineConfig } </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;Vite&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> reactRefresh </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;@Vitejs/plugin-react-refresh&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">export</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">default</span><span style="color:#F69D50;"> </span><span style="color:#DCBDFB;">defineConfig</span><span style="color:#F69D50;">({</span></span>
<span class="line"><span style="color:#F69D50;">  </span><span style="color:#ADBAC7;">plugins: [</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// react-refresh插件</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#DCBDFB;">reactRefresh</span><span style="color:#ADBAC7;">(),</span></span>
<span class="line"><span style="color:#ADBAC7;">  ]</span><span style="color:#F69D50;">,</span></span>
<span class="line"><span style="color:#F69D50;">})</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span></code></pre></div><p>修改 <code>package.json</code></p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#768390;">// package.json</span></span>
<span class="line"><span style="color:#ADBAC7;">{</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#8DDB8C;">&quot;scripts&quot;</span><span style="color:#ADBAC7;">: {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;start&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;Vite&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;build&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;Vite build&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;preview&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;Vite preview&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#FF938A;font-style:italic;">...</span></span>
<span class="line"><span style="color:#ADBAC7;">  }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span></code></pre></div><p>(如果没有使用 TypeScript，可以去除 <code>tsc</code>)</p><p>修改 <code>index.html</code></p><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#ADBAC7;">&lt;!</span><span style="color:#8DDB8C;">DOCTYPE</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">html</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;</span><span style="color:#8DDB8C;">html</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">lang</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;zh-CN&quot;</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">  &lt;</span><span style="color:#8DDB8C;">head</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">&lt;!-- ... --&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">link</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">rel</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;manifest&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">href</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;/src/assets/manifest.json&quot;</span><span style="color:#ADBAC7;"> /&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">link</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">rel</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;shortcut icon&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">href</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;/src/assets/favicon.ico&quot;</span><span style="color:#ADBAC7;"> /&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">&lt;!-- ... --&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">  &lt;/</span><span style="color:#8DDB8C;">head</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">  &lt;</span><span style="color:#8DDB8C;">body</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">&lt;!-- ... --&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">div</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">id</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;root&quot;</span><span style="color:#ADBAC7;">&gt;&lt;/</span><span style="color:#8DDB8C;">div</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">script</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">type</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;module&quot;</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">src</span><span style="color:#ADBAC7;">=</span><span style="color:#96D0FF;">&quot;/src/index.jsx&quot;</span><span style="color:#ADBAC7;">&gt;&lt;/</span><span style="color:#8DDB8C;">script</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">  &lt;/</span><span style="color:#8DDB8C;">body</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;/</span><span style="color:#8DDB8C;">html</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>将 <code>public/index.html</code> 移至根目录下，其他文件移至 <code>src/assets/</code> 下, 然后可以移除 <code>public</code> 目录。</p><h3 id="启动-dev-server" tabindex="-1">启动 dev server <a class="header-anchor" href="#启动-dev-server" aria-hidden="true">#</a></h3><div class="language-powershell"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#ADBAC7;">yarn start</span></span>
<span class="line"></span></code></pre></div><p><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202112261749614.png" alt="image-20210630180546833"><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202112261749274.png" alt="image-20210630180708132"></p><p>项目正常启动了，控制台抛出一大堆错误，无法显示页面，这时就<strong>需要我们对项目的开发环境和生产环境做一些调整</strong>，才能保证我们的项目正常运行。</p><h3 id="开发环境" tabindex="-1">开发环境 <a class="header-anchor" href="#开发环境" aria-hidden="true">#</a></h3><hr><h4 id="浏览器兼容" tabindex="-1">浏览器兼容 <a class="header-anchor" href="#浏览器兼容" aria-hidden="true">#</a></h4><p>Vite2 使用了 ESM ，不支持 IE 等旧浏览器，可以使用官方插件 <a href="https://github.com/Vitejs/Vite/tree/main/packages/plugin-legacy" target="_blank" rel="noreferrer">@Vitejs/plugin-legacy</a> 对其支持</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#768390;">// Vite.config.js</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> legacy </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;@Vitejs/plugin-legacy&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">export</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">default</span><span style="color:#F69D50;"> {</span></span>
<span class="line"><span style="color:#F69D50;">  </span><span style="color:#ADBAC7;">plugins: [</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#DCBDFB;">legacy</span><span style="color:#ADBAC7;">({</span></span>
<span class="line"><span style="color:#ADBAC7;">      targets: [</span><span style="color:#96D0FF;">&quot;defaults&quot;</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;not IE 11&quot;</span><span style="color:#ADBAC7;">],</span></span>
<span class="line"><span style="color:#ADBAC7;">    }),</span></span>
<span class="line"><span style="color:#ADBAC7;">  ]</span><span style="color:#F69D50;">,</span></span>
<span class="line"><span style="color:#F69D50;">}</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span></code></pre></div><h4 id="proxy" tabindex="-1">Proxy <a class="header-anchor" href="#proxy" aria-hidden="true">#</a></h4><p>为开发服务器配置自定义代理规则，我项目使用的是 <a href="https://www.npmjs.com/package/http-proxy-middleware" target="_blank" rel="noreferrer">http-proxy-middleware</a>。</p><p>在 Vite 中使用 <a href="https://Vitejs.cn/config/#server-proxy" target="_blank" rel="noreferrer">server.proxy</a> 配置代理</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#768390;">// Vite.config.js</span></span>
<span class="line"><span style="color:#F47067;">export</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">default</span><span style="color:#F69D50;"> </span><span style="color:#DCBDFB;">defineConfig</span><span style="color:#F69D50;">({</span></span>
<span class="line"><span style="color:#F69D50;">  </span><span style="color:#ADBAC7;">server: {</span></span>
<span class="line"><span style="color:#ADBAC7;">    proxy: {</span></span>
<span class="line"><span style="color:#ADBAC7;">      </span><span style="color:#96D0FF;">&quot;/xxxxService&quot;</span><span style="color:#ADBAC7;">: {</span></span>
<span class="line"><span style="color:#ADBAC7;">        target: </span><span style="color:#96D0FF;">&quot;http://xxxx.dev.com&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">        changeOrigin: </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#DCBDFB;">rewrite</span><span style="color:#ADBAC7;">: (</span><span style="color:#F69D50;">path</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> path.</span><span style="color:#DCBDFB;">replace</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">/</span><span style="color:#F47067;">^</span><span style="color:#8DDB8C;font-weight:bold;">\\/</span><span style="color:#96D0FF;">xxxxService/</span><span style="color:#ADBAC7;">, </span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;">),</span></span>
<span class="line"><span style="color:#ADBAC7;">      },</span></span>
<span class="line"><span style="color:#ADBAC7;">    },</span></span>
<span class="line"><span style="color:#ADBAC7;">  }</span><span style="color:#F69D50;">,</span></span>
<span class="line"><span style="color:#F69D50;">})</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span></code></pre></div><h4 id="自定义-antd-主题色" tabindex="-1">自定义 antd 主题色 <a class="header-anchor" href="#自定义-antd-主题色" aria-hidden="true">#</a></h4><p>使用 <a href="https://github.com/onebay/vite-plugin-imp" target="_blank" rel="noreferrer">vite-plugin-imp</a> 按需导入样式。</p><p>通过 css.preprocessorOptions 指定传递给 CSS 预处理器的选项，自定义样式。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#768390;">// Vite.config.js</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> VitePluginImp </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;Vite-plugin-imp&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">export</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">default</span><span style="color:#F69D50;"> </span><span style="color:#DCBDFB;">defineConfig</span><span style="color:#F69D50;">({</span></span>
<span class="line"><span style="color:#F69D50;">  </span><span style="color:#ADBAC7;">css: {</span></span>
<span class="line"><span style="color:#ADBAC7;">    preprocessorOptions: {</span></span>
<span class="line"><span style="color:#ADBAC7;">      less: {</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">// 支持内联 JavaScript</span></span>
<span class="line"><span style="color:#ADBAC7;">        javascriptEnabled: </span><span style="color:#6CB6FF;">true</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#768390;">// 重写 less 变量，定制样式</span></span>
<span class="line"><span style="color:#ADBAC7;">        modifyVars: {</span></span>
<span class="line"><span style="color:#ADBAC7;">          </span><span style="color:#96D0FF;">&#39;@primary-color&#39;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&#39;#29b7b7&#39;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">          </span><span style="color:#96D0FF;">&#39;@link-color&#39;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&#39;#29b7b7&#39;</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">      }</span></span>
<span class="line"><span style="color:#ADBAC7;">    },</span></span>
<span class="line"><span style="color:#ADBAC7;">  plugins: [</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 按需引用的插件, 因为主题设置不能 modifyVars</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#DCBDFB;">VitePluginImp</span><span style="color:#ADBAC7;">({</span></span>
<span class="line"><span style="color:#ADBAC7;">      libList: [</span></span>
<span class="line"><span style="color:#ADBAC7;">        {</span></span>
<span class="line"><span style="color:#ADBAC7;">          libName: </span><span style="color:#96D0FF;">&#39;antd&#39;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">          </span><span style="color:#DCBDFB;">style</span><span style="color:#ADBAC7;">: (</span><span style="color:#F69D50;">name</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">\`antd/es/\${</span><span style="color:#ADBAC7;">name</span><span style="color:#96D0FF;">}/style\`</span></span>
<span class="line"><span style="color:#ADBAC7;">        }</span></span>
<span class="line"><span style="color:#ADBAC7;">      ]</span></span>
<span class="line"><span style="color:#ADBAC7;">    })</span></span>
<span class="line"><span style="color:#ADBAC7;">  ],</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">})</span></span>
<span class="line"></span></code></pre></div><h4 id="postcss" tabindex="-1">Postcss <a class="header-anchor" href="#postcss" aria-hidden="true">#</a></h4><p><a href="https://Vitejs.cn/config/#css-postcss" target="_blank" rel="noreferrer">css.postcss</a></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> flexbugsFixes </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;postcss-flexbugs-fixes&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> presetEnv </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;postcss-preset-env&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> postcssNormalize </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;postcss-normalize&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">export</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">default</span><span style="color:#F69D50;"> </span><span style="color:#DCBDFB;">defineConfig</span><span style="color:#F69D50;">({</span></span>
<span class="line"><span style="color:#F69D50;">  </span><span style="color:#ADBAC7;">css: {</span></span>
<span class="line"><span style="color:#ADBAC7;">    postcss: {</span></span>
<span class="line"><span style="color:#ADBAC7;">      plugins: [</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#DCBDFB;">flexbugsFixes</span><span style="color:#ADBAC7;">(),</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#DCBDFB;">postcssNormalize</span><span style="color:#ADBAC7;">(),</span></span>
<span class="line"><span style="color:#ADBAC7;">        </span><span style="color:#DCBDFB;">presetEnv</span><span style="color:#ADBAC7;">({</span></span>
<span class="line"><span style="color:#ADBAC7;">          autoprefixer: {</span></span>
<span class="line"><span style="color:#ADBAC7;">            flexbox: </span><span style="color:#96D0FF;">&quot;no-2009&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">          },</span></span>
<span class="line"><span style="color:#ADBAC7;">          stage: </span><span style="color:#6CB6FF;">3</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">        }),</span></span>
<span class="line"><span style="color:#ADBAC7;">      ],</span></span>
<span class="line"><span style="color:#ADBAC7;">    },</span></span>
<span class="line"><span style="color:#ADBAC7;">  }</span><span style="color:#F69D50;">,</span></span>
<span class="line"><span style="color:#F69D50;">})</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span></code></pre></div><h4 id="路径别名问题" tabindex="-1">路径别名问题 <a class="header-anchor" href="#路径别名问题" aria-hidden="true">#</a></h4><p>❌ error:</p><p><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202112261749773.png" alt="image-20210630181211545"></p><p>🐛 Fix:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#768390;">// import { resolve } from &#39;path&#39;</span></span>
<span class="line"><span style="color:#768390;">// ...</span></span>
<span class="line"><span style="color:#F47067;">export</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">default</span><span style="color:#F69D50;"> </span><span style="color:#DCBDFB;">defineConfig</span><span style="color:#F69D50;">({</span></span>
<span class="line"><span style="color:#F69D50;">  </span><span style="color:#768390;">// ...</span></span>
<span class="line"><span style="color:#F69D50;">  </span><span style="color:#ADBAC7;">resolve: {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 写法1</span></span>
<span class="line"><span style="color:#ADBAC7;">    alias: [{ find:</span><span style="color:#96D0FF;"> /</span><span style="color:#F47067;">^</span><span style="color:#96D0FF;">~/</span><span style="color:#ADBAC7;">, replacement: </span><span style="color:#96D0FF;">&quot;&quot;</span><span style="color:#ADBAC7;"> }],</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 写法2</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// alias: {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">//   &#39;@&#39;: resolve(__dirname, &#39;src&#39;),</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// },</span></span>
<span class="line"><span style="color:#ADBAC7;">  }</span><span style="color:#F69D50;">,</span></span>
<span class="line"><span style="color:#F69D50;">})</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span></code></pre></div><blockquote><p><a href="https://github.com/Vitejs/Vite/issues/2185" target="_blank" rel="noreferrer">https://github.com/Vitejs/Vite/issues/2185</a></p></blockquote><h4 id="process-is-not-defined" tabindex="-1">process is not defined <a class="header-anchor" href="#process-is-not-defined" aria-hidden="true">#</a></h4><p>❌ error:</p><p>process is not defined</p><p>🐛 Fix:</p><p>Vite 中不再使用 <code>p<wbr>rocess.env.XXX</code> 来读取环境变量，取而代之的是使用 <a href="https://Vitejs.cn/guide/env-and-mode.html" target="_blank" rel="noreferrer">i<wbr>mport.meta.env</a> 对象上暴露环境变量</p><blockquote><p>为了防止意外地将一些环境变量泄漏到客户端，只有以 <code>VITE_</code> 为前缀的变量才会暴露给经过 Vite 处理的代码。</p></blockquote><p><a href="http://nodejs.cn/api/process/process_argv.html" target="_blank" rel="noreferrer">process.argv</a></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#F47067;">---</span><span style="color:#ADBAC7;"> p<wbr>rocess.env.</span><span style="color:#6CB6FF;">REACT_APP_BUILD_ENV</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> process.argv[</span><span style="color:#6CB6FF;">2</span><span style="color:#ADBAC7;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">---</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">const</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">env</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> p<wbr>rocess.env.</span><span style="color:#6CB6FF;">REACT_APP_BUILD_ENV</span></span>
<span class="line"><span style="color:#F47067;">+++</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">const</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">env</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">import</span><span style="color:#ADBAC7;">.</span><span style="color:#6CB6FF;">meta</span><span style="color:#ADBAC7;">.env.</span><span style="color:#6CB6FF;">VITE_APP_ENV</span></span>
<span class="line"></span></code></pre></div><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#768390;">// package.json</span></span>
<span class="line"><span style="color:#96D0FF;">&quot;scripts&quot;</span><span style="color:#ADBAC7;">: {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;start&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;cross-env VITE_APP_ENV=loacl Vite&quot;</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// ...</span></span>
<span class="line"><span style="color:#ADBAC7;">  },</span></span>
<span class="line"></span></code></pre></div><h4 id="vite-tsconfig-paths" tabindex="-1">Vite-tsconfig-paths <a class="header-anchor" href="#vite-tsconfig-paths" aria-hidden="true">#</a></h4><p>❌ error:</p><p>使用 tsconfig baseUrl 失效问题</p><p>🐛 Fix:</p><p><a href="https://github.com/aleclarson/Vite-tsconfig-paths" target="_blank" rel="noreferrer">Vite-tsconfig-paths</a> 提供 <a href="https://github.com/Vitejs/Vite" target="_blank" rel="noreferrer"><code>Vite</code></a> 使用 TypeScript 的路径映射解析导入的能力。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#F69D50;">plugins</span><span style="color:#ADBAC7;">: [</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// ...</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 解决 tsconfig baseUrl 失效问题</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#DCBDFB;">tsconfigPaths</span><span style="color:#ADBAC7;">(),</span></span>
<span class="line"><span style="color:#ADBAC7;">  ],</span></span>
<span class="line"></span></code></pre></div><h4 id="require-is-not-defined" tabindex="-1">require is not defined <a class="header-anchor" href="#require-is-not-defined" aria-hidden="true">#</a></h4><p>❌ error:</p><p><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202112261750088.png" alt="image-20210705135729627"></p><p>🐛 Fix:</p><p>浏览器是不支持 require ，通过 ESM 导入</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> qs </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&quot;query-string&quot;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span></code></pre></div><h4 id="global-is-not-defined" tabindex="-1">global is not defined <a class="header-anchor" href="#global-is-not-defined" aria-hidden="true">#</a></h4><p>❌ error:</p><p><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202112261750996.png" alt="image-20210705144234355"></p><p>🐛 Fix:</p><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#768390;">&lt;!-- index.html --&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;</span><span style="color:#8DDB8C;">script</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#F47067;">const</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">global</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> globalThis;</span></span>
<span class="line"><span style="color:#ADBAC7;">&lt;/</span><span style="color:#8DDB8C;">script</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"></span></code></pre></div><blockquote><p><a href="https://github.com/Vitejs/Vite/issues/2778" target="_blank" rel="noreferrer">https://github.com/Vitejs/Vite/issues/2778</a></p></blockquote><h3 id="生产环境" tabindex="-1">生产环境 <a class="header-anchor" href="#生产环境" aria-hidden="true">#</a></h3><hr><h4 id="修改输出路径" tabindex="-1">修改输出路径 <a class="header-anchor" href="#修改输出路径" aria-hidden="true">#</a></h4><p>指定输出路径（<a href="https://Vitejs.cn/config/#build-outdir" target="_blank" rel="noreferrer">默认为 dist</a>），我项目中使用的是 build 。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#F47067;">export</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">default</span><span style="color:#F69D50;"> </span><span style="color:#DCBDFB;">defineConfig</span><span style="color:#F69D50;">({</span></span>
<span class="line"><span style="color:#F69D50;">  </span><span style="color:#ADBAC7;">build: {</span></span>
<span class="line"><span style="color:#ADBAC7;">    outDir: </span><span style="color:#96D0FF;">&quot;build&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">  }</span><span style="color:#F69D50;">,</span></span>
<span class="line"><span style="color:#F69D50;">})</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span></code></pre></div><h4 id="环境变量配置" tabindex="-1">环境变量配置 <a class="header-anchor" href="#环境变量配置" aria-hidden="true">#</a></h4><p>这里根据项目的具体情况配置，以下仅作为参考</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#ADBAC7;">{</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#8DDB8C;">&quot;scripts&quot;</span><span style="color:#ADBAC7;">: {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;start&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;cross-env VITE_APP_ENV=localhost Vite&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;build&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;tsc &amp;&amp; Vite build --mode localhost&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;preview&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;Vite preview&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;build_dev&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;tsc &amp;&amp; Vite build --mode dev&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;build_demo&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;tsc &amp;&amp; Vite build --mode demo&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;build_testing&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;tsc &amp;&amp; Vite build --mode testing&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;test&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;node scripts/test.js&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;lint&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;eslint --ext jsx,js src&quot;</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#8DDB8C;">&quot;lint_fix&quot;</span><span style="color:#ADBAC7;">: </span><span style="color:#96D0FF;">&quot;eslint --fix src&quot;</span></span>
<span class="line"><span style="color:#ADBAC7;">  }</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-env"><button title="Copy Code" class="copy"></button><span class="lang">env</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#adbac7;">// .env.testing</span></span>
<span class="line"><span style="color:#adbac7;">NODE_ENV=production</span></span>
<span class="line"><span style="color:#adbac7;">VITE_APP_ENV=testing</span></span>
<span class="line"><span style="color:#adbac7;"></span></span></code></pre></div><h4 id="cannot-read-property-definelocale-of-undefined" tabindex="-1">Cannot read property &#39;defineLocale&#39; of undefined <a class="header-anchor" href="#cannot-read-property-definelocale-of-undefined" aria-hidden="true">#</a></h4><p><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202112261750685.png" alt="image-20210708113519756"></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#F47067;">---</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;moment/locale/zh-cn&#39;</span></span>
<span class="line"><span style="color:#F47067;">+++</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;moment/dist/locale/zh-cn&#39;</span></span>
<span class="line"></span></code></pre></div><h4 id="failed-to-resolve-module-specifier-indexof" tabindex="-1">Failed to resolve module specifier &quot;indexof&quot; <a class="header-anchor" href="#failed-to-resolve-module-specifier-indexof" aria-hidden="true">#</a></h4><p><img src="https://raw.githubusercontent.com/Jinyangava/blog-image/master/img/202112261750989.png" alt="image-20210708145138025"></p><p><a href="https://github.com/Vitejs/Vite/issues/2670" target="_blank" rel="noreferrer">https://github.com/Vitejs/Vite/issues/2670</a></p><p>调整完成后，项目就可以正常运行啦🎉。</p><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-hidden="true">#</a></h2><blockquote><p><a href="https://Vitejs.cn/" target="_blank" rel="noreferrer">https://Vitejs.cn/</a></p><p><a href="https://github.com/Vitejs/Vite/issues" target="_blank" rel="noreferrer">https://github.com/Vitejs/Vite/issues</a></p><p><a href="https://blog.mutoe.com/2021/react-Vite-migration/" target="_blank" rel="noreferrer">https://blog.mutoe.com/2021/react-Vite-migration/</a></p></blockquote>`,96),e=[o];function t(c,r,i,y,A,D){return a(),n("div",null,e)}const B=s(l,[["render",t]]);export{C as __pageData,B as default};
