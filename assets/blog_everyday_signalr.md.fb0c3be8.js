import{_ as s,o as n,c as a,a as l}from"./app.5b5c79b2.js";const B=JSON.parse('{"title":"React 中使用 SignalR","description":"","frontmatter":{},"headers":[],"relativePath":"blog/everyday/signalr.md","lastUpdated":1679813736000}'),p={name:"blog/everyday/signalr.md"},o=l(`<h1 id="react-中使用-signalr" tabindex="-1">React 中使用 SignalR <a class="header-anchor" href="#react-中使用-signalr" aria-hidden="true">#</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-hidden="true">#</a></h2><p>当遇到服务器需要<strong>实时</strong>地<strong>主动</strong>向客户端推送数据的需求时，可以通过 WebSocket 协议实现，如果服务器采用 .NET 框架，我们就可以使用微软官方提供 SignalR 技术。</p><p>本文将演示如何在 React 项目如何使用 SignalR，并通过自定义 hook 来简化使用。</p><h3 id="简单介绍下-signalr" tabindex="-1">简单介绍下 SignalR <a class="header-anchor" href="#简单介绍下-signalr" aria-hidden="true">#</a></h3><p><a href="https://learn.microsoft.com/en-us/aspnet/core/signalr/introduction?view=aspnetcore-7.0" target="_blank" rel="noreferrer">ASP.NET Core SignalR</a> 是一个库，可用于简化向应用添加实时 Web 功能，让服务器端代码能够将内容推送到客户端。</p><p>SignalR 支持以下用于处理实时通信的技术（按正常回退的顺序）：</p><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API" target="_blank" rel="noreferrer">WebSockets</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events" target="_blank" rel="noreferrer">Server-Sent Events</a></li><li>Long Polling</li></ul><p>SignalR <strong>自动选择</strong>服务器和客户端能力范围内的最佳传输方法。</p><p>也就是说：当 WebSockets 可用时，SignalR 将在底层使用 WebSockets，而当不可用时，它会优雅地回退到其他技术，同时保持应用程序代码不变。</p><p>HttpTransportType 枚举如下：</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#F47067;">export</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">declare</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">enum</span><span style="color:#ADBAC7;"> </span><span style="color:#F69D50;">HttpTransportType</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#768390;">/** Specifies no transport preference. */</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#6CB6FF;">None</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">0</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#768390;">/** Specifies the WebSockets transport. */</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#6CB6FF;">WebSockets</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">1</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#768390;">/** Specifies the Server-Sent Events transport. */</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#6CB6FF;">ServerSentEvents</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">2</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#768390;">/** Specifies the Long Polling transport. */</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#6CB6FF;">LongPolling</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">4</span><span style="color:#ADBAC7;">,</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span></code></pre></div><p>可以通过 HubConnectionBuilder 实例提供的 <a href="https://learn.microsoft.com/en-us/javascript/api/@microsoft/signalr/hubconnectionbuilder?view=signalr-js-latest#@microsoft-signalr-hubconnectionbuilder-withurl-1" target="_blank" rel="noreferrer">withUrl(string, HttpTransportType)</a> 方法指定传输协议。 比如：<code>.withUrl(hubUrl,signalR.HttpTransportType.WebSockets)</code></p><h2 id="实现" tabindex="-1">实现 <a class="header-anchor" href="#实现" aria-hidden="true">#</a></h2><h3 id="install" tabindex="-1">Install <a class="header-anchor" href="#install" aria-hidden="true">#</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#F69D50;">yarn</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">add</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">@microsoft/signalr</span></span>
<span class="line"></span></code></pre></div><h3 id="usage" tabindex="-1">Usage <a class="header-anchor" href="#usage" aria-hidden="true">#</a></h3><ol><li><strong>创建实例</strong>：在组件挂载时，使用 HubConnectionBuilder 类，创建 HubConnection 实例；</li><li><strong>建立连接</strong>：使用实例上的 <code>start()</code> 方法启动 SignalR 连接，返回的是一个 <code>Promise&lt;void&gt;</code> 所以可以做一些连接成功后续操作；</li><li><strong>监听事件</strong>：使用实例上的 <code>on(string, (args: any[]) =&gt; void)</code> 方法来监听服务器上的事件，第一个参数是订阅的事件名称，第二个参数是回调函数，用于处理接收到的消息；</li><li><strong>断开连接</strong>：在组件卸载时，使用实例上的 <code>stop()</code> 方法断开 SignalR 连接，返回的是一个 <code>Promise&lt;void&gt;</code> 所以可以做一些断开连接后续操作；</li></ol><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>SignalR 连接可能会因多种原因中断（网络问题，服务器故障，客户端脚本错误或内存泄漏等等）。</p><p>可以通过 HubConnectionBuilder 的 <code>withAutomaticReconnect()</code> 方法，在连接丢失时自动尝试重新连接。</p><p>默认情况下，客户端将分别等待 0、2、10 和 30 秒，然后尝试 4 次重新连接尝试。</p></div><p>实现源码：</p><div class="language-tsx"><button title="Copy Code" class="copy"></button><span class="lang">tsx</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> { useState, useEffect } </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;react&#39;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">*</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">as</span><span style="color:#ADBAC7;"> signalR </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;@microsoft/signalr&#39;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> urls </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;services/urls&#39;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> { useMount } </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;hooks&#39;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">export</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">default</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">function</span><span style="color:#F69D50;"> </span><span style="color:#DCBDFB;">MyComponent</span><span style="color:#F69D50;">() </span><span style="color:#ADBAC7;">{</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#F47067;">const</span><span style="color:#ADBAC7;"> [</span><span style="color:#6CB6FF;">hubConnection</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">setHubConnection</span><span style="color:#ADBAC7;">] </span><span style="color:#F47067;">=</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#DCBDFB;">useState</span><span style="color:#ADBAC7;">&lt;</span><span style="color:#F69D50;">signalR</span><span style="color:#ADBAC7;">.</span><span style="color:#F69D50;">HubConnection</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">|</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">&gt;(</span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#DCBDFB;">useMount</span><span style="color:#ADBAC7;">(() </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 1.组件挂载时，创建 HubConnection 实例</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">const</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">newConnection</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> signalR.</span><span style="color:#DCBDFB;">HubConnectionBuilder</span><span style="color:#ADBAC7;">()</span></span>
<span class="line"><span style="color:#ADBAC7;">      .</span><span style="color:#DCBDFB;">withUrl</span><span style="color:#ADBAC7;">(urls.hubUrl)</span></span>
<span class="line"><span style="color:#ADBAC7;">      .</span><span style="color:#DCBDFB;">withAutomaticReconnect</span><span style="color:#ADBAC7;">() </span><span style="color:#768390;">// 自动重连</span></span>
<span class="line"><span style="color:#ADBAC7;">      .</span><span style="color:#DCBDFB;">build</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#DCBDFB;">setHubConnection</span><span style="color:#ADBAC7;">(newConnection);</span></span>
<span class="line"><span style="color:#ADBAC7;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#DCBDFB;">useEffect</span><span style="color:#ADBAC7;">(() </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// 2.启动 SignalR 连接</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;"> (hubConnection) {</span></span>
<span class="line"><span style="color:#ADBAC7;">      hubConnection</span></span>
<span class="line"><span style="color:#ADBAC7;">        .</span><span style="color:#DCBDFB;">start</span><span style="color:#ADBAC7;">()</span></span>
<span class="line"><span style="color:#ADBAC7;">        .</span><span style="color:#DCBDFB;">then</span><span style="color:#ADBAC7;">(() </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">          console.</span><span style="color:#DCBDFB;">log</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&#39;SignalR Connected!&#39;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        })</span></span>
<span class="line"><span style="color:#ADBAC7;">        .</span><span style="color:#DCBDFB;">catch</span><span style="color:#ADBAC7;">((</span><span style="color:#F69D50;">err</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">          console.</span><span style="color:#DCBDFB;">log</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&#39;SignalR Connection Error: &#39;</span><span style="color:#ADBAC7;">, err);</span></span>
<span class="line"><span style="color:#ADBAC7;">        });</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> () </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">      </span><span style="color:#768390;">// 4.组件卸载时，断开 SignalR 连接</span></span>
<span class="line"><span style="color:#ADBAC7;">      </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;"> (hubConnection) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        hubConnection</span></span>
<span class="line"><span style="color:#ADBAC7;">          .</span><span style="color:#DCBDFB;">stop</span><span style="color:#ADBAC7;">()</span></span>
<span class="line"><span style="color:#ADBAC7;">          .</span><span style="color:#DCBDFB;">then</span><span style="color:#ADBAC7;">(() </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">            console.</span><span style="color:#DCBDFB;">log</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&#39;SignalR Disconnected!&#39;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">          })</span></span>
<span class="line"><span style="color:#ADBAC7;">          .</span><span style="color:#DCBDFB;">catch</span><span style="color:#ADBAC7;">((</span><span style="color:#F69D50;">err</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">            console.</span><span style="color:#DCBDFB;">log</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&#39;SignalR Disconnection Error: &#39;</span><span style="color:#ADBAC7;">, err);</span></span>
<span class="line"><span style="color:#ADBAC7;">          });</span></span>
<span class="line"><span style="color:#ADBAC7;">      }</span></span>
<span class="line"><span style="color:#ADBAC7;">    };</span></span>
<span class="line"><span style="color:#ADBAC7;">  }, [hubConnection]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#768390;">// 3.使用 hub 的 on 方法来监听服务器上的事件</span></span>
<span class="line"><span style="color:#ADBAC7;">  hubConnection?.</span><span style="color:#DCBDFB;">on</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&#39;ReceiveMessage&#39;</span><span style="color:#ADBAC7;">, (</span><span style="color:#F69D50;">data</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    console.</span><span style="color:#DCBDFB;">log</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">\`ReceiveMessage: \${</span><span style="color:#ADBAC7;">data</span><span style="color:#96D0FF;">}\`</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// omit logic</span></span>
<span class="line"><span style="color:#ADBAC7;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> (</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;</span><span style="color:#8DDB8C;">div</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">      &lt;</span><span style="color:#8DDB8C;">h1</span><span style="color:#ADBAC7;">&gt;SignalR Example&lt;/</span><span style="color:#8DDB8C;">h1</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">    &lt;/</span><span style="color:#8DDB8C;">div</span><span style="color:#ADBAC7;">&gt;</span></span>
<span class="line"><span style="color:#ADBAC7;">  );</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="usesignalr" tabindex="-1">useSignalR <a class="header-anchor" href="#usesignalr" aria-hidden="true">#</a></h3><p>使用自定义 hook 封装 SignalR 可以使代码更加简洁和可复用。</p><div class="language-tsx"><button title="Copy Code" class="copy"></button><span class="lang">tsx</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> { useState, useEffect } </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;react&#39;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">*</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">as</span><span style="color:#ADBAC7;"> signalR </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;@microsoft/signalr&#39;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">type</span><span style="color:#ADBAC7;"> { Urls } </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;types&#39;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> { useMount } </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;hooks&#39;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">export</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">default</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">function</span><span style="color:#F69D50;"> </span><span style="color:#DCBDFB;">useSignalR</span><span style="color:#F69D50;">(hubUrl</span><span style="color:#F47067;">:</span><span style="color:#F69D50;"> Urls) </span><span style="color:#ADBAC7;">{</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#F47067;">const</span><span style="color:#ADBAC7;"> [</span><span style="color:#6CB6FF;">hubConnection</span><span style="color:#ADBAC7;">, </span><span style="color:#6CB6FF;">setHubConnection</span><span style="color:#ADBAC7;">] </span><span style="color:#F47067;">=</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#DCBDFB;">useState</span><span style="color:#ADBAC7;">&lt;</span><span style="color:#F69D50;">signalR</span><span style="color:#ADBAC7;">.</span><span style="color:#F69D50;">HubConnection</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">|</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">&gt;(</span><span style="color:#6CB6FF;">null</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#DCBDFB;">useMount</span><span style="color:#ADBAC7;">(() </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">const</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">newConnection</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">new</span><span style="color:#ADBAC7;"> signalR.</span><span style="color:#DCBDFB;">HubConnectionBuilder</span><span style="color:#ADBAC7;">()</span></span>
<span class="line"><span style="color:#ADBAC7;">      .</span><span style="color:#DCBDFB;">withUrl</span><span style="color:#ADBAC7;">(urls.hubUrl)</span></span>
<span class="line"><span style="color:#ADBAC7;">      .</span><span style="color:#DCBDFB;">withAutomaticReconnect</span><span style="color:#ADBAC7;">()</span></span>
<span class="line"><span style="color:#ADBAC7;">      .</span><span style="color:#DCBDFB;">build</span><span style="color:#ADBAC7;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#DCBDFB;">setHubConnection</span><span style="color:#ADBAC7;">(newConnection);</span></span>
<span class="line"><span style="color:#ADBAC7;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#DCBDFB;">useEffect</span><span style="color:#ADBAC7;">(() </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;"> (hubConnection) {</span></span>
<span class="line"><span style="color:#ADBAC7;">      hubConnection</span></span>
<span class="line"><span style="color:#ADBAC7;">        .</span><span style="color:#DCBDFB;">start</span><span style="color:#ADBAC7;">()</span></span>
<span class="line"><span style="color:#ADBAC7;">        .</span><span style="color:#DCBDFB;">then</span><span style="color:#ADBAC7;">(() </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">          console.</span><span style="color:#DCBDFB;">log</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&#39;SignalR Connected!&#39;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">        })</span></span>
<span class="line"><span style="color:#ADBAC7;">        .</span><span style="color:#DCBDFB;">catch</span><span style="color:#ADBAC7;">((</span><span style="color:#F69D50;">err</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">          console.</span><span style="color:#DCBDFB;">log</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&#39;SignalR Connection Error: &#39;</span><span style="color:#ADBAC7;">, err);</span></span>
<span class="line"><span style="color:#ADBAC7;">        });</span></span>
<span class="line"><span style="color:#ADBAC7;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> () </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">      </span><span style="color:#F47067;">if</span><span style="color:#ADBAC7;"> (hubConnection) {</span></span>
<span class="line"><span style="color:#ADBAC7;">        hubConnection</span></span>
<span class="line"><span style="color:#ADBAC7;">          .</span><span style="color:#DCBDFB;">stop</span><span style="color:#ADBAC7;">()</span></span>
<span class="line"><span style="color:#ADBAC7;">          .</span><span style="color:#DCBDFB;">then</span><span style="color:#ADBAC7;">(() </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">            console.</span><span style="color:#DCBDFB;">log</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&#39;SignalR Disconnected!&#39;</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">          })</span></span>
<span class="line"><span style="color:#ADBAC7;">          .</span><span style="color:#DCBDFB;">catch</span><span style="color:#ADBAC7;">((</span><span style="color:#F69D50;">err</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">            console.</span><span style="color:#DCBDFB;">log</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&#39;SignalR Disconnection Error: &#39;</span><span style="color:#ADBAC7;">, err);</span></span>
<span class="line"><span style="color:#ADBAC7;">          });</span></span>
<span class="line"><span style="color:#ADBAC7;">      }</span></span>
<span class="line"><span style="color:#ADBAC7;">    };</span></span>
<span class="line"><span style="color:#ADBAC7;">  }, [hubConnection]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> hubConnection;</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span></code></pre></div><p>使用 useSignalR hook</p><div class="language-tsx"><button title="Copy Code" class="copy"></button><span class="lang">tsx</span><pre class="shiki github-dark-dimmed"><code><span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> useSignalR </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;./hook&#39;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"><span style="color:#F47067;">import</span><span style="color:#ADBAC7;"> urls </span><span style="color:#F47067;">from</span><span style="color:#ADBAC7;"> </span><span style="color:#96D0FF;">&#39;services/urls&#39;</span><span style="color:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F47067;">export</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">default</span><span style="color:#F69D50;"> </span><span style="color:#F47067;">function</span><span style="color:#F69D50;"> </span><span style="color:#DCBDFB;">MyComponent</span><span style="color:#F69D50;">() </span><span style="color:#ADBAC7;">{</span></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#F47067;">const</span><span style="color:#ADBAC7;"> </span><span style="color:#6CB6FF;">hubConnection</span><span style="color:#ADBAC7;"> </span><span style="color:#F47067;">=</span><span style="color:#ADBAC7;"> </span><span style="color:#DCBDFB;">useSignalR</span><span style="color:#ADBAC7;">(urls.hubUrl);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADBAC7;">  </span><span style="color:#768390;">// 使用 hubConnection.on 方法进行事件监听</span></span>
<span class="line"><span style="color:#ADBAC7;">  hubConnection?.</span><span style="color:#DCBDFB;">on</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">&#39;ReceiveMessage&#39;</span><span style="color:#ADBAC7;">, (</span><span style="color:#F69D50;">data</span><span style="color:#ADBAC7;">) </span><span style="color:#F47067;">=&gt;</span><span style="color:#ADBAC7;"> {</span></span>
<span class="line"><span style="color:#ADBAC7;">    console.</span><span style="color:#DCBDFB;">log</span><span style="color:#ADBAC7;">(</span><span style="color:#96D0FF;">\`ReceiveMessage: \${</span><span style="color:#ADBAC7;">data</span><span style="color:#96D0FF;">}\`</span><span style="color:#ADBAC7;">);</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// omit logic</span></span>
<span class="line"><span style="color:#ADBAC7;">  });</span></span>
<span class="line"><span style="color:#ADBAC7;">   </span><span style="color:#F47067;">return</span><span style="color:#ADBAC7;"> (</span></span>
<span class="line"><span style="color:#ADBAC7;">    </span><span style="color:#768390;">// omit rendering logic</span></span>
<span class="line"><span style="color:#ADBAC7;">   )</span></span>
<span class="line"><span style="color:#ADBAC7;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-hidden="true">#</a></h2><blockquote><p><a href="https://dotnet.microsoft.com/en-us/apps/aspnet/signalr" target="_blank" rel="noreferrer">https://dotnet.microsoft.com/en-us/apps/aspnet/signalr</a></p><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API" target="_blank" rel="noreferrer">https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API</a></p><p><a href="https://medium.com/swlh/creating-a-simple-real-time-chat-with-net-core-reactjs-and-signalr-6367dcadd2c6" target="_blank" rel="noreferrer">https://medium.com/swlh/creating-a-simple-real-time-chat-with-net-core-reactjs-and-signalr-6367dcadd2c6</a></p></blockquote>`,28),e=[o];function t(c,r,A,y,i,D){return n(),a("div",null,e)}const F=s(p,[["render",t]]);export{B as __pageData,F as default};
